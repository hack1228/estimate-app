<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Êõ∏È°û‰ΩúÊàê„Ç¢„Ç∑„Çπ„Çø„É≥„Éà</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    @media print {
      #header, #chat, #input-area { display: none !important; }
      #preview-wrap {
        display: block !important;
        box-shadow: none !important;
        margin: 0 !important;
        border-radius: 0 !important;
        max-width: 100% !important;
        padding: 20px !important;
      }
      body { background: white !important; }
    }
    body {
      font-family: 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', sans-serif;
      background: #f4f1eb;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    #header {
      background: #2d2d2d;
      color: #f4f1eb;
      padding: 16px 20px;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 2px;
    }
    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 20px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-width: 600px;
      width: 100%;
      margin: 0 auto;
    }
    .msg-row { display: flex; }
    .msg-row.bot { justify-content: flex-start; align-items: flex-start; gap: 8px; }
    .msg-row.user { justify-content: flex-end; }
    .bot-icon { font-size: 20px; flex-shrink: 0; }
    .bubble {
      padding: 12px 16px;
      max-width: 80%;
      white-space: pre-wrap;
      line-height: 1.6;
      font-size: 14px;
    }
    .bubble.bot { background: #2d2d2d; color: #f4f1eb; border-radius: 18px 18px 18px 4px; }
    .bubble.user { background: #c8b89a; color: #2d2d2d; border-radius: 18px 18px 4px 18px; }
    .btn-row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 4px; }
    .btn-dark {
      background: #2d2d2d; color: #f4f1eb; border: none;
      border-radius: 24px; padding: 12px 24px; font-size: 15px;
      cursor: pointer; font-family: inherit;
    }
    .btn-dark:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-light {
      background: #c8b89a; color: #2d2d2d; border: none;
      border-radius: 20px; padding: 10px 20px; font-size: 14px;
      cursor: pointer; font-family: inherit;
    }
    #input-area {
      padding: 12px 16px;
      background: white;
      border-top: 1px solid #e0d9ce;
      display: none;
      gap: 8px;
      max-width: 600px;
      width: 100%;
      margin: 0 auto;
    }
    #input-area.visible { display: flex; }
    #input-area input {
      flex: 1; border: 2px solid #c8b89a; border-radius: 12px;
      padding: 10px 14px; font-size: 15px; outline: none;
      font-family: inherit; background: white;
    }
    #input-area input:focus { border-color: #2d2d2d; }
    #input-area button {
      background: #2d2d2d; color: white; border: none;
      border-radius: 12px; padding: 10px 18px; font-size: 15px;
      cursor: pointer; font-family: inherit;
    }
    #preview-wrap {
      display: none;
      background: white;
      max-width: 700px;
      width: 100%;
      margin: 20px auto;
      padding: 40px 36px;
      border-radius: 8px;
      box-shadow: 0 2px 20px rgba(0,0,0,0.08);
    }
    #preview-wrap h1 {
      text-align: center;
      font-size: 26px;
      font-weight: 700;
      letter-spacing: 6px;
      margin-bottom: 28px;
    }
    .doc-header {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 28px;
    }
    .doc-to { font-size: 17px; font-weight: 600; }
    .doc-from { text-align: right; font-size: 13px; color: #555; }
    .doc-from .company-name { font-weight: 600; font-size: 15px; margin-bottom: 4px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    thead tr { background: #2d2d2d; color: white; }
    th { padding: 10px 12px; font-weight: 600; }
    th:first-child { text-align: left; }
    th:not(:first-child) { text-align: right; }
    td { padding: 10px 12px; border-bottom: 1px solid #e0d9ce; }
    td:first-child { text-align: left; }
    td:not(:first-child) { text-align: right; }
    .total-box {
      display: flex; justify-content: flex-end; margin-bottom: 20px;
    }
    .total-inner {
      background: #f4f1eb; padding: 14px 24px; border-radius: 8px; text-align: right;
    }
    .total-label { font-size: 13px; color: #666; margin-right: 16px; }
    .total-amount { font-size: 22px; font-weight: 700; }
    .note-section { border-top: 1px solid #e0d9ce; padding-top: 14px; }
    .note-label { font-size: 13px; color: #666; margin-bottom: 6px; }
    .note-text { font-size: 14px; white-space: pre-wrap; }
  </style>
</head>
<body>

<div id="header">üìÑ Êõ∏È°û‰ΩúÊàê„Ç¢„Ç∑„Çπ„Çø„É≥„Éà</div>

<div id="chat"></div>

<div id="input-area">
  <input type="text" id="text-input" placeholder="" />
  <button onclick="handleSend()">ÈÄÅ‰ø°</button>
</div>

<div id="preview-wrap">
  <h1 id="doc-title"></h1>
  <div class="doc-header">
    <div class="doc-to" id="doc-to"></div>
    <div class="doc-from">
      <div class="company-name" id="doc-mycompany"></div>
      <div id="doc-date"></div>
    </div>
  </div>
  <table>
    <thead>
      <tr>
        <th>ÂìÅÁõÆ</th>
        <th>Êï∞Èáè</th>
        <th>Âçò‰æ°</th>
        <th>Â∞èË®à</th>
      </tr>
    </thead>
    <tbody id="items-body"></tbody>
  </table>
  <div class="total-box">
    <div class="total-inner">
      <span class="total-label">ÂêàË®àÈáëÈ°ç</span>
      <span class="total-amount" id="total-amount"></span>
    </div>
  </div>
  <div class="note-section" id="note-section" style="display:none">
    <div class="note-label">ÂÇôËÄÉ</div>
    <div class="note-text" id="note-text"></div>
  </div>
</div>

<script>
  // --- State ---
  let step = 0;
  let docType = null;
  let myCompany = "";
  let company = "";
  let items = [{ name: "", qty: 1, price: 0 }];
  let note = "";
  let itemStep = 0;
  let currentItemIdx = 0;
  let addMore = false;

  function fmt(n) { return Number(n).toLocaleString("ja-JP"); }

  // --- DOM helpers ---
  const chat = document.getElementById("chat");
  const inputArea = document.getElementById("input-area");
  const textInput = document.getElementById("text-input");

  function addMsg(from, text) {
    const row = document.createElement("div");
    row.className = "msg-row " + from;
    if (from === "bot") {
      const icon = document.createElement("span");
      icon.className = "bot-icon";
      icon.textContent = "ü§ñ";
      row.appendChild(icon);
    }
    const bubble = document.createElement("div");
    bubble.className = "bubble " + from;
    bubble.textContent = text;
    row.appendChild(bubble);
    chat.appendChild(row);
    chat.scrollTop = chat.scrollHeight;
  }

  function addButtons(buttons) {
    const row = document.createElement("div");
    row.className = "btn-row";
    row.id = "btn-row-temp";
    buttons.forEach(b => {
      const btn = document.createElement("button");
      btn.className = b.style === "dark" ? "btn-dark" : "btn-light";
      btn.textContent = b.label;
      btn.onclick = () => { row.remove(); b.action(); };
      row.appendChild(btn);
    });
    chat.appendChild(row);
    chat.scrollTop = chat.scrollHeight;
  }

  function showInput(placeholder) {
    inputArea.classList.add("visible");
    textInput.placeholder = placeholder;
    textInput.value = "";
    textInput.focus();
  }

  function hideInput() {
    inputArea.classList.remove("visible");
  }

  // --- Init ---
  addMsg("bot", "„Åì„Çì„Å´„Å°„ÅØÔºÅÊõ∏È°û„Çí‰∏ÄÁ∑í„Å´‰Ωú„Çä„Åæ„Åó„Çá„ÅÜ„ÄÇ„Åæ„Åö„ÄÅ‰ΩúÊàê„Åô„ÇãÊõ∏È°û„ÅÆÁ®ÆÈ°û„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ");
  addButtons([
    { label: "Ë¶ãÁ©çÊõ∏", style: "dark", action: () => selectType("Ë¶ãÁ©çÊõ∏") },
    { label: "Ê≥®ÊñáÊõ∏", style: "dark", action: () => selectType("Ê≥®ÊñáÊõ∏") },
  ]);

  function selectType(type) {
    docType = type;
    addMsg("user", type);
    addMsg("bot", type + "„Çí‰ΩúÊàê„Åó„Åæ„Åô„ÄÇ\n„Åæ„Åö„ÄÅ„ÅÇ„Å™„Åü„ÅÆ‰ºöÁ§æÂêçÔºàÁô∫Ë°åËÄÖÂêçÔºâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
    step = 1;
    showInput("Ëá™Á§æ„ÅÆ‰ºöÁ§æÂêç„ÇíÂÖ•Âäõ...");
  }

  textInput.addEventListener("keydown", e => { if (e.key === "Enter") handleSend(); });

  function handleSend() {
    const val = textInput.value.trim();
    if (!val) return;
    textInput.value = "";

    if (step === 1) {
      myCompany = val;
      addMsg("user", val);
      addMsg("bot", "„Äå" + val + "„Äç„Åß„Åô„Å≠„ÄÇ\nÊ¨°„Å´„ÄÅÂÆõÂÖà„ÅÆ‰ºöÁ§æÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
      step = 2;
      showInput("ÂÆõÂÖà„ÅÆ‰ºöÁ§æÂêç„ÇíÂÖ•Âäõ...");

    } else if (step === 2) {
      company = val;
      addMsg("user", val);
      addMsg("bot", "„Äå" + val + "„ÄçÂæ°‰∏≠„Åß„Åô„Å≠„ÄÇ\nÊ¨°„Å´ÂìÅÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n„Åæ„Åö„ÄÅÂìÅÁõÆÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
      step = 3;
      itemStep = 0;
      currentItemIdx = 0;
      items = [{ name: "", qty: 1, price: 0 }];
      showInput("ÂìÅÁõÆÂêç„ÇíÂÖ•Âäõ...");

    } else if (step === 3) {
      handleItemInput(val);

    } else if (step === 4) {
      note = (val === "„Å™„Åó" || val === "„Çπ„Ç≠„ÉÉ„Éó") ? "" : val;
      addMsg("user", val);
      addMsg("bot", "ÂÜÖÂÆπ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
      hideInput();
      step = 5;
      showPreview();
      const btnRow = document.createElement("div");
      btnRow.className = "btn-row";
      btnRow.style.marginTop = "8px";

      const pdfBtn = document.createElement("button");
      pdfBtn.className = "btn-dark";
      pdfBtn.textContent = "üñ®Ô∏è PDF„Åß‰øùÂ≠ò";
      pdfBtn.onclick = exportPDF;

      const resetBtn = document.createElement("button");
      resetBtn.className = "btn-light";
      resetBtn.textContent = "ÊúÄÂàù„Åã„Çâ„ÇÑ„ÇäÁõ¥„Åô";
      resetBtn.onclick = reset;

      btnRow.appendChild(pdfBtn);
      btnRow.appendChild(resetBtn);
      chat.appendChild(btnRow);
      chat.scrollTop = chat.scrollHeight;
    }
  }

  function handleItemInput(val) {
    if (itemStep === 0) {
      items[currentItemIdx].name = val;
      addMsg("user", val);
      addMsg("bot", "Êï∞Èáè„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
      itemStep = 1;
      showInput("Êï∞Èáè„ÇíÂÖ•Âäõ...");

    } else if (itemStep === 1) {
      items[currentItemIdx].qty = Number(val) || 1;
      addMsg("user", val);
      addMsg("bot", "Âçò‰æ°„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàÂÜÜÔºâ„ÄÇ");
      itemStep = 2;
      showInput("Âçò‰æ°„ÇíÂÖ•ÂäõÔºàÂÜÜÔºâ...");

    } else if (itemStep === 2) {
      items[currentItemIdx].price = Number(val.replace(/,/g, "")) || 0;
      const sub = items[currentItemIdx].qty * items[currentItemIdx].price;
      addMsg("user", val);
      addMsg("bot", "Â∞èË®àÔºö¬•" + fmt(sub) + "\n‰ªñ„Å´ÂìÅÁõÆ„ÇíËøΩÂä†„Åó„Åæ„Åô„ÅãÔºü");
      itemStep = 0;
      hideInput();
      addButtons([
        { label: "„ÅØ„ÅÑ„ÄÅËøΩÂä†„Åô„Çã", style: "light", action: () => addMoreItem(true) },
        { label: "„ÅÑ„ÅÑ„Åà„ÄÅÂÆå‰∫Ü", style: "light", action: () => addMoreItem(false) },
      ]);
    }
  }

  function addMoreItem(yes) {
    if (yes) {
      items.push({ name: "", qty: 1, price: 0 });
      currentItemIdx = items.length - 1;
      addMsg("user", "„ÅØ„ÅÑ");
      addMsg("bot", "Ê¨°„ÅÆÂìÅÁõÆÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
      showInput("ÂìÅÁõÆÂêç„ÇíÂÖ•Âäõ...");
    } else {
      addMsg("user", "„ÅÑ„ÅÑ„Åà");
      addMsg("bot", "ÂÇôËÄÉ„Åå„ÅÇ„Çå„Å∞ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\nÔºà‰∏çË¶Å„Å™Â†¥Âêà„ÅØ„Äå„Å™„Åó„Äç„Å®ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ");
      step = 4;
      showInput("ÂÇôËÄÉ„ÇíÂÖ•ÂäõÔºà‰∏çË¶Å„Å™„Çâ„Äå„Å™„Åó„ÄçÔºâ...");
    }
  }

  function showPreview() {
    const today = new Date().toLocaleDateString("ja-JP", { year: "numeric", month: "long", day: "numeric" });
    document.getElementById("doc-title").textContent = docType;
    document.getElementById("doc-to").textContent = company + " Âæ°‰∏≠";
    document.getElementById("doc-mycompany").textContent = myCompany;
    document.getElementById("doc-date").textContent = "Áô∫Ë°åÊó•Ôºö" + today;

    const tbody = document.getElementById("items-body");
    tbody.innerHTML = "";
    let total = 0;
    items.forEach(item => {
      const sub = item.qty * item.price;
      total += sub;
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${item.name}</td><td style="text-align:right">${item.qty}</td><td style="text-align:right">¬•${fmt(item.price)}</td><td style="text-align:right">¬•${fmt(sub)}</td>`;
      tbody.appendChild(tr);
    });
    document.getElementById("total-amount").textContent = "¬•" + fmt(total);

    if (note) {
      document.getElementById("note-section").style.display = "block";
      document.getElementById("note-text").textContent = note;
    } else {
      document.getElementById("note-section").style.display = "none";
    }
    document.getElementById("preview-wrap").style.display = "block";
  }

  function exportPDF() {
    window.print();
  }

  function reset() {
    step = 0; docType = null; myCompany = ""; company = "";
    items = [{ name: "", qty: 1, price: 0 }]; note = "";
    itemStep = 0; currentItemIdx = 0;
    chat.innerHTML = "";
    document.getElementById("preview-wrap").style.display = "none";
    hideInput();
    addMsg("bot", "„Åì„Çì„Å´„Å°„ÅØÔºÅÊõ∏È°û„Çí‰∏ÄÁ∑í„Å´‰Ωú„Çä„Åæ„Åó„Çá„ÅÜ„ÄÇ„Åæ„Åö„ÄÅ‰ΩúÊàê„Åô„ÇãÊõ∏È°û„ÅÆÁ®ÆÈ°û„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ");
    addButtons([
      { label: "Ë¶ãÁ©çÊõ∏", style: "dark", action: () => selectType("Ë¶ãÁ©çÊõ∏") },
      { label: "Ê≥®ÊñáÊõ∏", style: "dark", action: () => selectType("Ê≥®ÊñáÊõ∏") },
    ]);
  }
</script>
</body>
</html>
